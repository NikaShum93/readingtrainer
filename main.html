<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReadingTrainer ‚Äî main</title>
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Comfortaa:wght@400;700&family=PT+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Roboto:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bgColor:#111; --textColor:#eee; --titleColor:#ffd700; --highlightColor:#ffd700;
      --highlightRGBA: rgba(255,215,0,1); --borderColor:#ffd700;
      --fontFamily:'Comfortaa',cursive; --fontSize:28px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:var(--bgColor);
      color:var(--textColor);
      font-family:var(--fontFamily);
      padding:16px;
      display:flex;justify-content:center;align-items:flex-start
    }
    #container{
      width:min(960px,100%);
      background:rgba(0,0,0,.15);
      border:3px solid var(--borderColor);
      border-radius:18px;
      box-shadow:0 4px 26px #0006;
      overflow:hidden
    }
    .no-frame #container{border:none;background:transparent;box-shadow:none}
    #titleArea{
      text-align:center; font-weight:700; font-size:clamp(22px,3.2vw,34px);
      color:var(--titleColor); padding:14px 20px 6px;
      font-family:'UnifrakturCook',cursive
    }
    #controls{
      display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(255,255,255,.06)
    }
    .spacer{flex:1}
    button{
      background:none; border:none; cursor:pointer; font-size:20px;
      color:var(--highlightColor); padding:6px 8px; border-radius:8px
    }
    button:hover{background:var(--highlightColor); color:#222}
    button:disabled{opacity:.5; cursor:not-allowed}
    #speedWrap{display:flex;align-items:center;gap:8px}
    #speedRange{width:180px}
    #displayArea{
      padding:16px 20px 22px; font-size:var(--fontSize); line-height:1.6;
      white-space:pre-wrap; max-height:60vh; overflow:auto
    }
    #displayArea::-webkit-scrollbar{width:10px}
    #displayArea::-webkit-scrollbar-thumb{background:var(--highlightColor);border-radius:10px}
    .highlight{
      background:var(--highlightRGBA); color:#222; font-weight:700;
      border-radius:6px; padding:0 4px; transition:background .2s
    }
    .highlight.text{ background:none !important; color:var(--highlightColor) !important }
    #audioWrap{padding:0 20px 16px; display:flex; justify-content:center}
    audio{width:100%; max-width:520px}
  </style>
</head>
<body>
  <div id="container">
    <div id="titleArea"></div>

    <div id="controls">
      <button id="recordBtn" title="–ó–∞–ø–∏—Å—å/–°—Ç–æ–ø –∑–∞–ø–∏—Å—å">üî¥</button>
      <div class="spacer"></div>
      <div id="speedWrap">
        <label for="speedRange">–°–∫–æ—Ä–æ—Å—Ç—å</label>
        <input type="range" id="speedRange" min="0.5" max="2.5" step="0.1" value="1">
        <span id="speedVal">1.0√ó</span>
      </div>
      <button id="playBtn" title="–°—Ç–∞—Ä—Ç/–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å">‚ñ∂Ô∏è</button>
      <button id="pauseBtn" title="–ü–∞—É–∑–∞" disabled>‚è∏Ô∏è</button>
      <button id="stopBtn" title="–°—Ç–æ–ø" disabled>‚èπÔ∏è</button>
    </div>

    <div id="displayArea" aria-live="polite" aria-atomic="true"></div>
    <div id="audioWrap"></div>
  </div>

  <script>
    // --- utils ---
    const qp = Object.fromEntries(new URLSearchParams(location.search).entries());
    const cfg = {
      title: qp.title ?? '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
      text: qp.text ?? '–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è.',
      highlightColor: qp.highlightColor ?? '#ffd700',
      highlightOpacity: (qp.highlightOpacity ?? '1'),
      textColor: qp.textColor ?? '#eee',
      titleColor: qp.titleColor ?? '#ffd700',
      bgColor: qp.bgColor ?? '#111',
      borderColor: qp.borderColor ?? '', // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª–∞ –Ω–∏–∂–µ
      fontFamily: qp.fontFamily ?? "'Comfortaa', cursive",
      fontSize: (qp.fontSize ?? 28) + 'px',
      highlightStyle: qp.highlightStyle ?? 'background'
    };

    function hexToRgb(hex){
      let c = hex.trim();
      if (c.startsWith('rgb')) {
        // rgb/rgba already
        const nums = c.replace(/[^\d.,]/g,'').split(',').map(Number);
        return {r:nums[0]||255,g:nums[1]||215,b:nums[2]||0};
      }
      if (c[0]==='#') c=c.slice(1);
      if (c.length===3) c = c.split('').map(ch=>ch+ch).join('');
      const n = parseInt(c,16);
      return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
    }

    // CSS vars
    document.documentElement.style.setProperty('--bgColor', cfg.bgColor);
    document.documentElement.style.setProperty('--textColor', cfg.textColor);
    document.documentElement.style.setProperty('--titleColor', cfg.titleColor);
    document.documentElement.style.setProperty('--highlightColor', cfg.highlightColor);
    document.documentElement.style.setProperty('--fontFamily', cfg.fontFamily);
    document.documentElement.style.setProperty('--fontSize', cfg.fontSize);

    // highlight RGBA from color + opacity
    const {r,g,b} = hexToRgb(cfg.highlightColor);
    const op = Math.max(0, Math.min(1, parseFloat(cfg.highlightOpacity)||0)); // clamp 0..1
    document.documentElement.style.setProperty('--highlightRGBA', `rgba(${r},${g},${b},${op})`);

    const container = document.getElementById('container');
    // Border logic
    if (cfg.borderColor) {
      document.documentElement.style.setProperty('--borderColor', cfg.borderColor);
    } else {
      // –µ—Å–ª–∏ borderColor –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –±–µ—Ä—ë–º –∏–∑ highlightColor
      document.documentElement.style.setProperty('--borderColor', cfg.highlightColor);
    }

    // –ï—Å–ª–∏ —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π:
    if ((cfg.bgColor || '').toLowerCase() === 'transparent') {
      if (!cfg.borderColor) {
        // –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –∏ borderColor –Ω–µ –∑–∞–¥–∞–Ω ‚Üí –±–µ–∑ —Ä–∞–º–∫–∏/—Ç–µ–Ω–∏
        document.body.classList.add('no-frame');
      } else {
        // –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω, –Ω–æ borderColor –µ—Å—Ç—å ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–º–∫—É
        document.body.classList.remove('no-frame');
      }
    }

    // Title & text
    const titleArea = document.getElementById('titleArea');
    const displayArea = document.getElementById('displayArea');
    titleArea.textContent = cfg.title;
    displayArea.textContent = cfg.text;

    // Controls
    const speedRange = document.getElementById('speedRange');
    const speedVal = document.getElementById('speedVal');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recordBtn = document.getElementById('recordBtn');
    const audioWrap = document.getElementById('audioWrap');

    speedVal.textContent = parseFloat(speedRange.value).toFixed(1)+'√ó';

    // --- Highlighter engine ---
    let words = [];
    let idx = 0;
    let timer = null;
    let running = false;
    let paused = false;
    let player = null; // <audio>

    function tokenize(text){ return text.trim().split(/\s+/); }

    function render(index){
      const styled = words.map((w,i)=>{
        if (i!==index) return w;
        if (cfg.highlightStyle==='text'){
          return `<span class="highlight text">${w}</span>`;
        }
        return `<span class="highlight">${w}</span>`;
      }).join(' ');
      displayArea.innerHTML = styled;
      const el = displayArea.querySelector('.highlight');
      if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function pauseMul(word){
      if(!word) return 1;
      const ch = word.slice(-1);
      if ('.!?'.includes(ch)) return 3;
      if (',:;'.includes(ch)) return 2;
      return 1;
    }

    function step(){
      if (idx >= words.length){ finish(); return; }
      if (paused) return;
      render(idx);
      const base = 280, perChar = 65;
      const speed = parseFloat(speedRange.value);
      const delay = (base + words[idx].length*perChar) * pauseMul(words[idx]) / speed;
      idx++;
      timer = setTimeout(step, delay);
    }

    function start(){
      if (running && paused){
        paused = false; playBtn.disabled = true; pauseBtn.disabled = false; stopBtn.disabled = false;
        if (player && player.paused) { player.playbackRate = parseFloat(speedRange.value); player.play().catch(()=>{}); }
        step(); return;
      }
      if (running) return;
      words = tokenize(cfg.text); idx = 0; running = true; paused = false;
      playBtn.disabled = true; pauseBtn.disabled = false; stopBtn.disabled = false;
      if (player) { player.currentTime = 0; player.playbackRate = parseFloat(speedRange.value); player.play().catch(()=>{}); }
      step();
    }

    function pause(){
      if (!running) return;
      paused = true; playBtn.disabled = false; pauseBtn.disabled = true;
      if (player && !player.paused) player.pause();
    }

    function stop(){
      running = false; paused = false; clearTimeout(timer); idx = 0;
      displayArea.textContent = cfg.text;
      playBtn.disabled = false; pauseBtn.disabled = true; stopBtn.disabled = true;
      if (player){ player.pause(); player.currentTime = 0; }
    }

    function finish(){
      running = false; paused = false; playBtn.disabled = false; pauseBtn.disabled = true; stopBtn.disabled = true;
    }

    playBtn.addEventListener('click', start);
    pauseBtn.addEventListener('click', pause);
    stopBtn.addEventListener('click', stop);

    speedRange.addEventListener('input', ()=>{
      speedVal.textContent = parseFloat(speedRange.value).toFixed(1)+'√ó';
      if (player) player.playbackRate = parseFloat(speedRange.value);
      if (running && !paused){ clearTimeout(timer); step(); }
    });

    // --- Recording ---
    let mediaRecorder = null;
    let chunks = [];
    let isRec = false;

    async function toggleRecord(){
      if (isRec){ mediaRecorder.stop(); return; }
      if (!navigator.mediaDevices?.getUserMedia){ alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ'); return; }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
          audioWrap.innerHTML = '';
          const blob = new Blob(chunks, {type:'audio/webm'});
          const url = URL.createObjectURL(blob);
          player = new Audio(url);
          player.controls = true;
          player.playbackRate = parseFloat(speedRange.value);
          audioWrap.appendChild(player);
        };
        mediaRecorder.start();
        isRec = true; recordBtn.textContent = '‚èπÔ∏è';
      }catch(err){
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
      }
    }

    recordBtn.addEventListener('click', ()=>{
      if (isRec){ mediaRecorder.stop(); isRec=false; recordBtn.textContent='üî¥'; }
      else toggleRecord();
    });
  </script>
</body>
</html>
