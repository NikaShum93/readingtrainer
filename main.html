<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reading Trainer ‚Äî main</title>
<style>
:root{
  --bgRGBA: rgba(0,0,0,0);
  --textColor:#fff8e1;
  --titleColor:#ffd700;
  --highlightColor:#30c391;
  --highlightRGBA: rgba(48,195,145,0.45);
  --borderColor:#30c391;
  --borderRadius:18px;
  --fontFamily: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --fontSize:28px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:transparent; color:var(--textColor); font-family:var(--fontFamily);
  display:flex; justify-content:center; align-items:flex-start; padding:16px;
}
#wrap{
  width:min(960px,100%);
  background:var(--bgRGBA);
  border:3px solid var(--borderColor);
  border-radius:var(--borderRadius);
  box-shadow:0 4px 26px #0006; overflow:hidden;
}
.no-border #wrap{ border:none; box-shadow:none }
#title{ text-align:center; font-weight:800; font-size:clamp(22px,3.2vw,34px); color:var(--titleColor); padding:14px 18px 6px; text-shadow:0 0 10px color-mix(in oklab, var(--titleColor) 40%, transparent) }

#bar{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; background:rgba(255,255,255,.08); margin:0 12px 8px; border-radius:10px;
}
.sp{flex:1}
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:36px; height:36px; border-radius:9px; border:1px solid transparent;
  background:transparent; color:var(--titleColor); cursor:pointer;
}
.btn:hover{ background:rgba(255,255,255,.12) }
.btn:disabled{ opacity:.4; cursor:not-allowed }
.ico{ width:20px; height:20px; fill:currentColor }
#spd{display:flex;align-items:center;gap:8px}
#rng{width:200px}

#text{
  padding:12px 18px 18px; font-size:var(--fontSize); line-height:1.6; white-space:pre-wrap; max-height:60vh
}
#text.no-scroll{ overflow:hidden; scrollbar-width:none }
#text.has-scroll{ overflow:auto; scrollbar-width:thin; scrollbar-color: var(--highlightColor) transparent }
#text.has-scroll::-webkit-scrollbar{ width:8px }
#text.has-scroll::-webkit-scrollbar-thumb{ background:var(--highlightColor); border-radius:8px; opacity:.5 }

/* –º—è–≥–∫–∞—è ¬´—Å–≤–µ—Ç—è—â–∞—è—Å—è¬ª –ø–æ–¥–ª–æ–∂–∫–∞ –ø–æ–¥ —Å–ª–æ–≤–æ–º */
.hl{
  background: radial-gradient(120% 70% at 50% 55%,
              color-mix(in oklab, var(--highlightRGBA) 85%, transparent) 0%,
              color-mix(in oklab, var(--highlightRGBA) 65%, transparent) 55%,
              transparent 100%);
  background-repeat:no-repeat;
  background-size:100% 1.2em;
  background-position:0 .18em;
  border-radius:.35em;
  padding:0 .02em;
  font-weight:inherit;
}
.hl.text{
  background:none !important;
  color:var(--highlightColor) !important;
  text-shadow:0 0 .6em color-mix(in oklab, var(--highlightColor) 50%, transparent);
}

#audioBox{ padding:6px 14px 10px; display:flex; justify-content:center; gap:8px }
audio{ width:100%; max-width:540px }
#err{ color:#ffc6c6; text-align:center; padding:6px 14px 10px; white-space:pre-wrap }

@media (prefers-reduced-motion: reduce) {
  * { scroll-behavior: auto !important; }
}
</style>
</head>
<body>
  <div id="wrap">
    <div id="title"></div>

    <div id="bar">
      <button id="rec" class="btn" title="–ó–∞–ø–∏—Å—å/–°—Ç–æ–ø">
        <svg class="ico" viewBox="0 0 24 24"><path id="recPath" d="M12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
      </button>

      <button id="play"  class="btn" title="–°—Ç–∞—Ä—Ç / –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å">
        <svg class="ico" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="pause" class="btn" title="–ü–∞—É–∑–∞" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button id="stop"  class="btn" title="–°—Ç–æ–ø" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
      </button>

      <div class="sp"></div>

      <div id="spd" title="–°–∫–æ—Ä–æ—Å—Ç—å">
        <span>‚è±</span>
        <input id="rng" type="range" min="0.5" max="2.5" step="0.1" value="1">
        <span id="sv">1.0√ó</span>
      </div>

      <button id="open" class="btn" title="–û—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M14 3l7 7-7 7v-4H3V7h11V3z"/></svg>
      </button>
      <button id="dl" class="btn" title="–°–∫–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm7-18l-5 5h3v6h4V7h3l-5-5z"/></svg>
      </button>
    </div>

    <div id="text" aria-live="polite" aria-atomic="true"></div>
    <div id="err"></div>
    <div id="audioBox"></div>
  </div>

<script>
/* ===== –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL ===== */
const qp   = Object.fromEntries(new URLSearchParams(location.search).entries());
const BASE = 'https://nikashum93.github.io/texts/data/';
const id   = qp.id || '';
const directDataURL = qp.data ? decodeURIComponent(qp.data) : '';

/* ===== —Ç–µ–º–∞ ===== */
function cssRGBA(hex, a){
  let s=(hex||'').trim(); if(!s) return `rgba(0,0,0,${a})`;
  if(s[0]==='#') s=s.slice(1); if(s.length===3) s=s.split('').map(c=>c+c).join('');
  const n=parseInt(s,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
  return `rgba(${r},${g},${b},${a})`;
}
let HIGHLIGHT_TEXT = false;
function applyTheme(d){
  document.documentElement.style.setProperty('--fontFamily', d.fontFamily || getComputedStyle(document.documentElement).getPropertyValue('--fontFamily'));
  document.documentElement.style.setProperty('--fontSize', (d.fontSize||28)+'px');
  document.documentElement.style.setProperty('--textColor', d.textColor||'#fff8e1');
  document.documentElement.style.setProperty('--titleColor', d.titleColor||d.highlightColor||'#ffd700');
  document.documentElement.style.setProperty('--highlightColor', d.highlightColor||'#ffd700');
  const ho = (d.highlightOpacity ?? 0.45);
  document.documentElement.style.setProperty('--highlightRGBA', cssRGBA(d.highlightColor||'#ffd700', ho));
  document.documentElement.style.setProperty('--borderRadius', (d.borderRadius||18)+'px');
  const bg = cssRGBA(d.bgColor||'#0b271f', d.bgOpacity ?? 0.25);
  document.documentElement.style.setProperty('--bgRGBA', bg);
  if(d.border==='none'){ document.body.classList.add('no-border'); }
  else{
    document.body.classList.remove('no-border');
    document.documentElement.style.setProperty('--borderColor', d.borderColor||d.highlightColor||'#30c391');
  }
  HIGHLIGHT_TEXT = (d.highlightStyle === 'text');
}

/* ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (—Å —Å–≤–µ—Ä—Ö-–Ω–∞–¥—ë–∂–Ω—ã–º —Ñ–æ–ª–ª–±–µ–∫–æ–º –∏ –ª–æ–≥–∞–º–∏) ===== */
async function safeParseJSON(resp){
  try { return await resp.clone().json(); } catch { return null; }
}
async function safeParseText(resp){
  try { return await resp.clone().text(); } catch { return null; }
}
async function fetchNoStore(url){
  const r = await fetch(url, { cache: 'no-store' });
  return r;
}

async function loadData(){
  // 0) –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ ?data= (JSON)
  if (directDataURL) {
    console.log('üîé data preview ‚Üí', directDataURL);
    const r = await fetchNoStore(directDataURL);
    if (!r.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data: ' + directDataURL);
    return r.json();
  }

  if (!id) {
    return {
      title: '–ü—Ä–∏–º–µ—Ä',
      text: '–ü–µ—Ä–µ–¥–∞–π—Ç–µ ?id=‚Ä¶ (txt/json –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è) –∏–ª–∏ ?data=‚Ä¶ (–ø—Ä–µ–≤—å—é).',
      fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
      fontSize: 28,
      textColor: "#fff8e1",
      highlightColor: "#ffd700",
      highlightOpacity: 0.45,
      highlightStyle: "background",
      bgColor: "#0b271f",
      bgOpacity: 0.25,
      border: "solid",
      borderColor: "#30c391",
      borderRadius: 18
    };
  }

  const escId = encodeURIComponent(id);
  const txtURL  = `${BASE}${escId}.txt?v=${Date.now()}`;
  const jsonURL = `${BASE}${escId}.json?v=${Date.now()}`;

  let txtStatus = null, jsonStatus = null;

  // 1) –ø—Ä–æ–±—É–µ–º .txt
  console.log('üîé try TXT:', txtURL);
  let r = await fetchNoStore(txtURL);
  txtStatus = r.status;
  if (r.ok) {
    const txt = await r.text();
    console.log('‚úÖ loaded TXT');
    return { text: txt };
  } else {
    console.log('‚ùå TXT status', r.status);
  }

  // 2) –ø—Ä–æ–±—É–µ–º .json
  console.log('üîé try JSON:', jsonURL);
  r = await fetchNoStore(jsonURL);
  jsonStatus = r.status;
  if (r.ok) {
    // —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON
    const asJson = await safeParseJSON(r);
    if (asJson) {
      if (typeof asJson === 'string') { console.log('‚úÖ JSON is string'); return { text: asJson }; }
      if (asJson && typeof asJson.text === 'string') { console.log('‚úÖ JSON {text}'); return { text: asJson.text, title: asJson.title || '' }; }
    }
    // –µ—Å–ª–∏ –Ω–µ JSON ‚Äî —á–∏—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
    const asText = await safeParseText(r);
    if (asText != null) { console.log('‚úÖ JSON file contained plain text'); return { text: asText }; }
  } else {
    console.log('‚ùå JSON status', r.status);
  }

  throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:\nTXT ${txtStatus} ‚Üí ${txtURL}\nJSON ${jsonStatus} ‚Üí ${jsonURL}`);
}

/* ===== –¥–≤–∏–∂–æ–∫ —á—Ç–µ–Ω–∏—è ===== */
const textEl = document.getElementById('text');
const errEl  = document.getElementById('err');
let TEXT = '';
let words=[], wordSpans=[], cur=-1, i=0, timer=null, running=false, paused=false;

function tokenize(t){ return (t||'').trim().split(/\s+/); }
function pMul(w){ if(!w) return 1; const ch=w.slice(-1); if('.!?'.includes(ch))return 3; if(',:;'.includes(ch))return 2; return 1; }
function buildWordsDOM(){
  textEl.innerHTML = '';
  wordSpans = [];
  const frag = document.createDocumentFragment();
  words.forEach((w, idx) => {
    const span = document.createElement('span');
    span.textContent = w;
    wordSpans.push(span);
    frag.appendChild(span);
    if (idx !== words.length - 1) frag.appendChild(document.createTextNode(' '));
  });
  textEl.appendChild(frag);
}
function scrollIfNeeded(el){
  const c = textEl.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  const pad = 20;
  const out = r.top < c.top + pad || r.bottom > c.bottom - pad;
  if (out) el.scrollIntoView({block:'center', inline:'nearest'});
}
function highlightAt(n){
  if (n === cur) return;
  if (cur >= 0 && wordSpans[cur]) wordSpans[cur].classList.remove('hl','text');
  if (n >= 0 && wordSpans[n]) {
    wordSpans[n].classList.add(HIGHLIGHT_TEXT ? 'text' : 'hl');
    scrollIfNeeded(wordSpans[n]);
  }
  cur = n;
}
function renderReset(){ words = tokenize(TEXT); i = 0; cur = -1; buildWordsDOM(); }
function step(){
  if(i >= words.length){ done(); return; }
  if(paused) return;
  highlightAt(i);
  const base=280, per=65, speed=parseFloat(rng.value);
  const delay=(base + words[i].length*per) * pMul(words[i]) / speed;
  i++; timer=setTimeout(step, delay);
}
function start(){
  if(running && paused){
    paused=false; play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
    if(player&&player.paused){player.playbackRate=parseFloat(rng.value); player.play().catch(()=>{});}
    step(); return;
  }
  if(running) return;
  renderReset();
  running=true; paused=false;
  play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
  if(player){ player.currentTime=0; player.playbackRate=parseFloat(rng.value); player.play().catch(()=>{}); }
  step();
}
function pause(){ if(!running) return; paused=true; play.disabled=false; pauseBtn.disabled=true; if(player&&!player.paused) player.pause(); }
function stopRead(){
  running=false; paused=false; clearTimeout(timer);
  renderReset(); smartScroll();
  play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true;
  if(player){ player.pause(); player.currentTime=0; }
}
function done(){ running=false; paused=false; play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true; }
function smartScroll(){
  requestAnimationFrame(()=>{
    const overflow = textEl.scrollHeight > textEl.clientHeight + 1;
    textEl.classList.toggle('has-scroll', overflow);
    textEl.classList.toggle('no-scroll', !overflow);
  });
}
addEventListener('resize', smartScroll);

/* —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
const play   = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const stopBtn  = document.getElementById('stop');
const rng    = document.getElementById('rng');
const sv     = document.getElementById('sv');
sv.textContent = parseFloat(rng.value).toFixed(1)+'√ó';
play.addEventListener('click', start);
pauseBtn.addEventListener('click', pause);
stopBtn.addEventListener('click', stopRead);
rng.addEventListener('input', ()=>{
  sv.textContent = parseFloat(rng.value).toFixed(1)+'√ó';
  if(player) player.playbackRate = parseFloat(rng.value);
  if(running && !paused){ clearTimeout(timer); step(); }
});

/* –∑–∞–ø–∏—Å—å */
const rec = document.getElementById('rec');
const recPath = document.getElementById('recPath');
const openBtn = document.getElementById('open');
const dlBtn = document.getElementById('dl');
const audioBox = document.getElementById('audioBox');
let mediaRecorder=null, chunks=[], recording=false, lastBlob=null, lastUrl=null, player=null;
function setActions(en){ openBtn.disabled = !en; dlBtn.disabled = !en; }
setActions(false);
rec.addEventListener('click', async ()=>{
  if(recording){ mediaRecorder.stop(); return; }
  if(!navigator.mediaDevices?.getUserMedia) return alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/wav';
    mediaRecorder = new MediaRecorder(stream,{mimeType:mime});
    chunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      if(lastUrl) URL.revokeObjectURL(lastUrl);
      audioBox.innerHTML='';
      lastBlob = new Blob(chunks,{type:mime});
      lastUrl = URL.createObjectURL(lastBlob);
      player = new Audio(lastUrl);
      player.controls = true;
      player.playbackRate = parseFloat(rng.value);
      audioBox.appendChild(player);
      recording=false;
      recPath.setAttribute('d','M12 7a5 5 0 100 10 5 5 0 000-10z');
      setActions(true);
    };
    mediaRecorder.start();
    recording=true;
    recPath.setAttribute('d','M6 6h12v12H6z');
  }catch(e){ alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: '+e.message); }
});
openBtn.addEventListener('click', ()=>{
  if(!lastBlob) return;
  const u = lastUrl || URL.createObjectURL(lastBlob);
  window.open(u,'_blank','noopener');
});
dlBtn.addEventListener('click', ()=>{
  if(!lastBlob) return;
  const a=document.createElement('a');
  a.href = lastUrl || URL.createObjectURL(lastBlob);
  a.download = 'reading-recording.' + (lastBlob.type.includes('webm')?'webm':'wav');
  a.click();
});

/* –∑–∞–ø—É—Å–∫ */
async function init(){
  try{
    const data = await loadData();
    const themed = {
      title: qp.title ?? data.title ?? '',
      text: data.text ?? '',
      fontFamily: qp.fontFamily ?? data.fontFamily,
      fontSize: +(qp.fontSize ?? data.fontSize ?? 28),
      textColor: qp.textColor ?? data.textColor,
      titleColor: qp.titleColor ?? data.titleColor,
      highlightColor: qp.highlightColor ?? data.highlightColor,
      highlightOpacity: +(qp.highlightOpacity ?? data.highlightOpacity ?? 0.45),
      highlightStyle: qp.highlightStyle ?? data.highlightStyle ?? 'background',
      bgColor: qp.bgColor ?? data.bgColor,
      bgOpacity: +(qp.bgOpacity ?? data.bgOpacity ?? 0.25),
      border: qp.border ?? data.border,
      borderColor: qp.borderColor ?? data.borderColor,
      borderRadius: +(qp.borderRadius ?? data.borderRadius ?? 18)
    };
    applyTheme(themed);
    document.getElementById('title').textContent = themed.title || '';
    TEXT = themed.text || '';
    renderReset();
    smartScroll();
  }catch(e){
    document.getElementById('title').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    errEl.textContent = '‚ö† ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
    console.error(e);
  }
}
init();
</script>
</body>
</html>
