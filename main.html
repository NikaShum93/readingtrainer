<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reading Trainer — main</title>
<style>
:root{
  --bgRGBA: rgba(0,0,0,0);
  --textColor:#fff8e1;
  --titleColor:#ffd700;
  --highlightColor:#30c391;
  --highlightRGBA: rgba(48,195,145,0.9);
  --borderColor:#30c391;
  --borderRadius:18px;
  --fontFamily: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --fontSize:28px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:transparent; color:var(--textColor); font-family:var(--fontFamily);
  display:flex; justify-content:center; align-items:flex-start; padding:16px;
}
#wrap{
  width:min(960px,100%);
  background:var(--bgRGBA);
  border:3px solid var(--borderColor);
  border-radius:var(--borderRadius);
  box-shadow:0 4px 26px #0006; overflow:hidden;
}
.no-border #wrap{ border:none; box-shadow:none }
#title{ text-align:center; font-weight:800; font-size:clamp(22px,3.2vw,34px); color:var(--titleColor); padding:14px 18px 6px }

#bar{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; background:rgba(255,255,255,.08); margin:0 12px 8px; border-radius:10px;
}
.sp{flex:1}
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:36px; height:36px; border-radius:9px; border:1px solid transparent;
  background:transparent; color:var(--titleColor); cursor:pointer;
}
.btn:hover{ background:rgba(255,255,255,.12) }
.btn:disabled{ opacity:.4; cursor:not-allowed }
.ico{ width:20px; height:20px; fill:currentColor }
#spd{display:flex;align-items:center;gap:8px}
#rng{width:200px}

#text{
  padding:12px 18px 18px; font-size:var(--fontSize); line-height:1.6; white-space:pre-wrap; max-height:60vh
}
#text.no-scroll{ overflow:hidden; scrollbar-width:none }
#text.has-scroll{ overflow:auto; scrollbar-width:thin; scrollbar-color: var(--highlightColor) transparent }
#text.has-scroll::-webkit-scrollbar{ width:8px }
#text.has-scroll::-webkit-scrollbar-thumb{ background:var(--highlightColor); border-radius:8px; opacity:.5 }

/* Подсветка без изменения метрик */
.hl{
  background: linear-gradient(var(--highlightRGBA), var(--highlightRGBA));
  background-repeat: no-repeat;
  background-size: 100% 1.15em;     /* высота маркера */
  background-position: 0 0.08em;    /* смещение вниз */
  border-radius: 4px;
  padding: 0;
  font-weight: inherit;
}
.hl.text{
  background: none !important;
  color: var(--highlightColor) !important;
  text-shadow: 0 0 0.35em var(--highlightColor);
}

#audioBox{ padding:6px 14px 10px; display:flex; justify-content:center }
audio{ width:100%; max-width:540px }
#err{ color:#ffc6c6; text-align:center; padding:6px 14px 10px; white-space:pre-wrap }
</style>
</head>
<body>
  <div id="wrap">
    <div id="title"></div>

    <div id="bar">
      <button id="rec" class="btn" title="Запись/Стоп">
        <svg class="ico" viewBox="0 0 24 24"><path id="recPath" d="M12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
      </button>

      <div class="sp"></div>

      <div id="spd" title="Скорость">
        <span>⏱</span>
        <input id="rng" type="range" min="0.5" max="2.5" step="0.1" value="1">
        <span id="sv">1.0×</span>
      </div>

      <button id="play"  class="btn" title="Старт/Продолжить">
        <svg class="ico" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="pause" class="btn" title="Пауза" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button id="stop"  class="btn" title="Стоп" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
      </button>

      <button id="open" class="btn" title="Открыть запись" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M14 3l7 7-7 7v-4H3V7h11V3z"/></svg>
      </button>
      <button id="dl" class="btn" title="Скачать запись" disabled>
        <svg class="ico" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm7-18l-5 5h3v6h4V7h3l-5-5z"/></svg>
      </button>
    </div>

    <div id="text" aria-live="polite" aria-atomic="true"></div>
    <div id="err"></div>
    <div id="audioBox"></div>
  </div>

<script>
const qp = Object.fromEntries(new URLSearchParams(location.search).entries());
const BASE = 'https://nikashum93.github.io/texts/data/'; // где лежат опубликованные задания

const directDataURL = qp.data || '';  // ?data=... (в т.ч. data:application/json,...)
const id = qp.id || '';               // ?id=...

init();

async function init(){
  try{
    const data = await loadData();
    applyTheme(data);
    document.getElementById('title').textContent = data.title || 'Заголовок';
    TEXT = data.text || '';
    renderReset();
    smartScroll();
  }catch(e){
    document.getElementById('title').textContent = 'Ошибка загрузки';
    document.getElementById('err').textContent =
      '⚠ ' + (e.message || 'Не удалось получить данные') +
      (id ? '\nПодождите 30–60 сек: GitHub Pages может кешировать публикацию.' : '');
  }
}

async function loadData(){
  // 1) Режим предпросмотра: ?data=...
  if (directDataURL) {
    // поддерживаем data: и http(s)
    if (directDataURL.startsWith('data:')) {
      const r = await fetch(directDataURL);
      return r.json();
    }
    if (/^https?:/i.test(directDataURL)) {
      const r = await fetch(directDataURL, {cache:'no-store'});
      if (!r.ok) throw new Error('Недоступно: ' + directDataURL);
      return r.json();
    }
    throw new Error('Неподдерживаемый параметр data');
  }

  // 2) Боевой режим: ?id=...
  if (id) {
    const url = `${BASE}${encodeURIComponent(id)}.json?v=${Date.now()}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('Не найдено или недоступно: ' + url);
    return r.json();
  }

  // 3) Запасной текст, если без параметров
  return {
    title: 'Пример',
    text: 'Добавьте ?id=… (после публикации) или ?data=… (предпросмотр) к адресу main.html.',
    fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
    fontSize: 28,
    textColor: "#fff8e1",
    highlightColor: "#34d399",
    highlightOpacity: 1,
    highlightStyle: "background",
    bgColor: "#0c1a14",
    bgOpacity: 0.25,
    border: "solid",
    borderColor: "#34d399",
    borderRadius: 18
  };
}

/* ===== тема ===== */
function hexToRgb(hex){
  let s=(hex||'').trim(); if(!s) return {r:0,g:0,b:0};
  if(s[0]==='#') s=s.slice(1); if(s.length===3) s=s.split('').map(c=>c+c).join('');
  const n=parseInt(s,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
}
function cssRGBA(hex, a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }

let HIGHLIGHT_TEXT = false;
function applyTheme(d){
  document.documentElement.style.setProperty('--fontFamily', d.fontFamily || getComputedStyle(document.documentElement).getPropertyValue('--fontFamily'));
  document.documentElement.style.setProperty('--fontSize', (d.fontSize||28)+'px');
  document.documentElement.style.setProperty('--textColor', d.textColor||'#fff8e1');
  document.documentElement.style.setProperty('--titleColor', d.titleColor||d.highlightColor||'#30c391');
  document.documentElement.style.setProperty('--highlightColor', d.highlightColor||'#30c391');
  document.documentElement.style.setProperty('--highlightRGBA', cssRGBA(d.highlightColor||'#30c391', d.highlightOpacity ?? 1));
  document.documentElement.style.setProperty('--borderRadius', (d.borderRadius||18)+'px');
  const bg = cssRGBA(d.bgColor||'#091611', d.bgOpacity ?? 0);
  document.documentElement.style.setProperty('--bgRGBA', bg);
  if(d.border==='none'){ document.body.classList.add('no-border'); }
  else{
    document.body.classList.remove('no-border');
    document.documentElement.style.setProperty('--borderColor', d.borderColor||d.highlightColor||'#30c391');
  }
  HIGHLIGHT_TEXT = (d.highlightStyle === 'text');
}

/* ===== движок чтения без перерисовок ===== */
const textEl = document.getElementById('text');
let TEXT = '';
let words=[], wordSpans=[], cur=-1, i=0, timer=null, running=false, paused=false;

function tokenize(t){ return (t||'').trim().split(/\s+/); }
function pMul(w){ if(!w) return 1; const ch=w.slice(-1); if('.!?'.includes(ch))return 3; if(',:;'.includes(ch))return 2; return 1; }

function buildWordsDOM(){
  textEl.innerHTML = '';
  wordSpans = [];
  const frag = document.createDocumentFragment();
  words.forEach((w, idx) => {
    const span = document.createElement('span');
    span.textContent = w;
    wordSpans.push(span);
    frag.appendChild(span);
    if (idx !== words.length - 1) frag.appendChild(document.createTextNode(' '));
  });
  textEl.appendChild(frag);
}

function highlightAt(n){
  if (n === cur) return;
  if (cur >= 0 && wordSpans[cur]) wordSpans[cur].classList.remove('hl','text');
  if (n >= 0 && wordSpans[n]) {
    wordSpans[n].classList.add(HIGHLIGHT_TEXT ? 'text' : 'hl');
    wordSpans[n].scrollIntoView({behavior:'smooth', block:'center', inline:'nearest'});
  }
  cur = n;
}

function renderReset(){
  words = tokenize(TEXT);
  i = 0; cur = -1;
  buildWordsDOM();
}

function step(){
  if(i >= words.length){ done(); return; }
  if(paused) return;
  highlightAt(i);
  const base=280, per=65, speed=parseFloat(rng.value);
  const delay=(base + words[i].length*per) * pMul(words[i]) / speed;
  i++; timer=setTimeout(step, delay);
}

function start(){
  if(running && paused){
    paused=false; play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
    if(player&&player.paused){player.playbackRate=parseFloat(rng.value); player.play().catch(()=>{});}
    step(); return;
  }
  if(running) return;
  renderReset();
  running=true; paused=false;
  play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
  if(player){ player.currentTime=0; player.playbackRate=parseFloat(rng.value); player.play().catch(()=>{}); }
  step();
}
function pause(){ if(!running) return; paused=true; play.disabled=false; pauseBtn.disabled=true; if(player&&!player.paused) player.pause(); }
function stopRead(){
  running=false; paused=false; clearTimeout(timer);
  renderReset(); smartScroll();
  play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true;
  if(player){ player.pause(); player.currentTime=0; }
}
function done(){ running=false; paused=false; play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true; }

/* умный скролл */
function smartScroll(){
  requestAnimationFrame(()=>{
    const overflow = textEl.scrollHeight > textEl.clientHeight + 1;
    textEl.classList.toggle('has-scroll', overflow);
    textEl.classList.toggle('no-scroll', !overflow);
  });
}
addEventListener('resize', smartScroll);

/* ===== управление и скорость ===== */
const play = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const stopBtn = document.getElementById('stop');
const rng = document.getElementById('rng');
const sv = document.getElementById('sv');
sv.textContent = parseFloat(rng.value).toFixed(1)+'×';
play.addEventListener('click', start);
pauseBtn.addEventListener('click', pause);
stopBtn.addEventListener('click', stopRead);
rng.addEventListener('input', ()=>{
  sv.textContent = parseFloat(rng.value).toFixed(1)+'×';
  if(player) player.playbackRate = parseFloat(rng.value);
  if(running && !paused){ clearTimeout(timer); step(); }
});

/* ===== запись + открыть/скачать ===== */
const rec = document.getElementById('rec');
const recPath = document.getElementById('recPath');
const openBtn = document.getElementById('open');
const dlBtn = document.getElementById('dl');
const audioBox = document.getElementById('audioBox');
let mediaRecorder=null, chunks=[], recording=false, lastBlob=null, lastUrl=null, player=null;

function setActions(en){ openBtn.disabled = !en; dlBtn.disabled = !en; }
setActions(false);

rec.addEventListener('click', async ()=>{
  if(recording){ mediaRecorder.stop(); return; }
  if(!navigator.mediaDevices?.getUserMedia) return alert('Браузер не поддерживает запись аудио');

  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/wav';
    mediaRecorder = new MediaRecorder(stream,{mimeType:mime});
    chunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      if(lastUrl) URL.revokeObjectURL(lastUrl);
      audioBox.innerHTML='';
      lastBlob = new Blob(chunks,{type:mime});
      lastUrl = URL.createObjectURL(lastBlob);
      player = new Audio(lastUrl);
      player.controls = true;
      player.playbackRate = parseFloat(rng.value);
      audioBox.appendChild(player);
      recording=false;
      recPath.setAttribute('d','M12 7a5 5 0 100 10 5 5 0 000-10z'); // круг
      setActions(true);
    };
    mediaRecorder.start();
    recording=true;
    recPath.setAttribute('d','M6 6h12v12H6z'); // квадрат
  }catch(e){ alert('Ошибка доступа к микрофону: '+e.message); }
});

openBtn.addEventListener('click', ()=>{
  if(!lastBlob) return;
  const u = lastUrl || URL.createObjectURL(lastBlob);
  window.open(u,'_blank','noopener');
});
dlBtn.addEventListener('click', ()=>{
  if(!lastBlob) return;
  const a=document.createElement('a');
  a.href = lastUrl || URL.createObjectURL(lastBlob);
  a.download = 'reading-recording.' + (lastBlob.type.includes('webm')?'webm':'wav');
  a.click();
});
</script>
</body>
</html>
