<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reading Trainer by Nika Shum</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 40px 20px;
    }
    h1 {
      text-align: center;
      font-size: 36px;
      margin-bottom: 40px;
      color: #b9fbc0;
    }
    .sentence {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 30px;
      line-height: 1.8;
    }
    .word {
      padding: 4px 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .word.highlight {
      background-color: rgba(255, 255, 0, 0.6);
      box-shadow: 0 0 5px 2px rgba(255, 255, 0, 0.5);
    }
    .audio-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 30px;
    }
    .audio-controls button {
      background: #4b3f72;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .audio-controls button:hover {
      background: #7f5af0;
    }
    .downloads {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .downloads a {
      color: #9ef01a;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Loading...</h1>
    <div class="sentence" id="text"></div>
    <div class="audio-controls">
      <button id="record">üî¥ –ó–∞–ø–∏—Å–∞—Ç—å</button>
      <button id="play" disabled>‚ñ∂Ô∏è –ü—Ä–æ—Å–ª—É—à–∞—Ç—å</button>
    </div>
    <div class="downloads" id="downloads"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const title = decodeURIComponent(urlParams.get('title') || 'Reading Trainer');
    const text = decodeURIComponent(urlParams.get('text') || '');
    const speed = parseFloat(urlParams.get('speed')) || 1;

    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');
    const playBtn = document.getElementById('play');
    const recordBtn = document.getElementById('record');
    const downloads = document.getElementById('downloads');

    titleEl.textContent = title;

    const words = text.split(/\s+/);
    words.forEach(word => {
      const span = document.createElement('span');
      span.className = 'word';
      span.textContent = word;
      textEl.appendChild(span);
    });

    const wordEls = document.querySelectorAll('.word');

    function highlightWords() {
      let i = 0;
      function highlight() {
        if (i > 0) wordEls[i - 1].classList.remove('highlight');
        if (i < wordEls.length) {
          wordEls[i].classList.add('highlight');
          i++;
          setTimeout(highlight, 600 / speed);
        }
      }
      highlight();
    }

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    recordBtn.onclick = async () => {
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);

        // Create audio element
        const audio = new Audio(audioUrl);
        playBtn.disabled = false;
        playBtn.onclick = () => {
          audio.play();
          highlightWords();
        };

        // Download links
        downloads.innerHTML = '';

        const webmLink = document.createElement('a');
        webmLink.href = audioUrl;
        webmLink.download = 'recording.webm';
        webmLink.textContent = '–°–∫–∞—á–∞—Ç—å .webm';
        downloads.appendChild(webmLink);

        // Convert to mp3 using ffmpeg.wasm (in-browser)
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        await ffmpeg.load();
        await ffmpeg.FS('writeFile', 'input.webm', await fetchFile(audioBlob));
        await ffmpeg.run('-i', 'input.webm', 'output.mp3');
        const mp3Data = ffmpeg.FS('readFile', 'output.mp3');
        const mp3Blob = new Blob([mp3Data.buffer], { type: 'audio/mpeg' });
        const mp3Url = URL.createObjectURL(mp3Blob);

        const mp3Link = document.createElement('a');
        mp3Link.href = mp3Url;
        mp3Link.download = 'recording.mp3';
        mp3Link.textContent = '–°–∫–∞—á–∞—Ç—å .mp3';
        downloads.appendChild(mp3Link);
      };
      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), text.split(/\s+/).length * 800);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.js"></script>
</body>
</html>
