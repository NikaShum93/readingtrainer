<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reading Trainer — main</title>
<style>
:root{
  --bgRGBA: rgba(0,0,0,0);
  --textColor:#fff8e1;
  --titleColor:#ffd700;
  --highlightColor:#ffd700;
  --highlightRGBA: rgba(255,215,0,0.3);
  --borderColor:#34d399;
  --borderRadius:18px;
  --fontFamily: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --fontSize:28px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:transparent; color:var(--textColor); font-family:var(--fontFamily);
  display:flex; justify-content:center; align-items:flex-start; padding:16px;
}
#wrap{
  width:min(960px,100%);
  background:var(--bgRGBA);
  border:3px solid var(--borderColor);
  border-radius:var(--borderRadius);
  box-shadow:0 4px 26px #0006; overflow:hidden;
}
.no-border #wrap{ border:none; box-shadow:none }
#title{ text-align:center; font-weight:800; font-size:clamp(22px,3.2vw,34px); color:var(--titleColor); padding:14px 18px 6px }

#bar{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; background:rgba(255,255,255,.08); margin:0 12px 8px; border-radius:10px;
}
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:36px; height:36px; border-radius:9px; border:1px solid transparent;
  background:transparent; color:var(--titleColor); cursor:pointer;
}
.btn:hover{ background:rgba(255,255,255,.12) }
.btn:disabled{ opacity:.4; cursor:not-allowed }
.ico{ width:20px; height:20px; fill:currentColor }
.sp{flex:1}
#spd{display:flex;align-items:center;gap:8px}
#rng{width:200px}

#text{
  padding:12px 18px 18px; font-size:var(--fontSize); line-height:1.6; white-space:pre-wrap; max-height:60vh
}
#text.no-scroll{ overflow:hidden; scrollbar-width:none }
#text.has-scroll{ overflow:auto; scrollbar-width:thin; scrollbar-color: var(--highlightColor) transparent }
#text.has-scroll::-webkit-scrollbar{ width:8px }
#text.has-scroll::-webkit-scrollbar-thumb{ background:var(--highlightColor); border-radius:8px }

/* Мягкая подсветка под словом */
.hl{
  background: radial-gradient( ellipse at center,
              var(--highlightRGBA) 0%,
              rgba(0,0,0,0) 70%);
  padding: 0 .12em;
  border-radius: .35em;
}

#audioBox{ padding:6px 14px 10px; display:flex; justify-content:center }
audio{ width:100%; max-width:540px }
#err{ color:#ffc6c6; text-align:center; padding:6px 14px 10px; white-space:pre-wrap }
</style>
</head>
<body>
  <div id="wrap">
    <div id="title"></div>

    <div id="bar">
      <button id="play"  class="btn" title="Читать"><svg class="ico" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
      <button id="pause" class="btn" title="Пауза" disabled><svg class="ico" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
      <button id="stop"  class="btn" title="Стоп" disabled><svg class="ico" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg></button>
      <div class="sp"></div>
      <div id="spd" title="Скорость">
        <span>⏱</span>
        <input id="rng" type="range" min="0.5" max="2.5" step="0.1" value="1">
        <span id="sv">1.0×</span>
      </div>
    </div>

    <div id="text" aria-live="polite" aria-atomic="true"></div>
    <div id="err"></div>
    <div id="audioBox"></div>
  </div>

<script>
const qp = Object.fromEntries(new URLSearchParams(location.search).entries());
const BASE_TXT = 'https://nikashum93.github.io/texts/data/';

const titleEl = document.getElementById('title');
const textEl  = document.getElementById('text');
const errEl   = document.getElementById('err');

titleEl.textContent = ""; // никаких "..."

init();

async function init(){
  try{
    const data = await loadData(); // {title, text}
    // Заголовок: из URL приоритетно, иначе из файла
    titleEl.textContent = (qp.title && qp.title.trim()) || (data.title || "");

    applyThemeFromURL();
    TEXT = data.text || '';
    renderReset();
    smartScroll();
  }catch(e){
    titleEl.textContent = "Ошибка загрузки";
    errEl.textContent =
      '⚠ ' + (e.message || 'Не удалось получить данные') +
      (qp.id ? '\nПодождите 30–60 сек: GitHub Pages может кешировать публикацию.' : '');
  }
}

async function loadData(){
  if (qp.data) {
    const dataURL = decodeURIComponent(qp.data);
    const r = await fetch(dataURL);
    if (!r.ok) throw new Error('Не удалось загрузить data: JSON');
    return r.json();
  }
  if (qp.id) {
    const url = `${BASE_TXT}${encodeURIComponent(qp.id)}.json?v=${Date.now()}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('Не найдено или недоступно: '+url);
    return r.json();
  }
  return { title:'', text:'' };
}

/* ===== ТЕМА ИЗ URL ===== */
function hexToRgb(hex){ let s=(hex||'').trim(); if(!s) return {r:0,g:0,b:0}; if(s[0]==='#') s=s.slice(1); if(s.length===3) s=s.split('').map(c=>c+c).join(''); const n=parseInt(s,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
function cssRGBA(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
function applyThemeFromURL(){
  const val = (k, d)=> (qp[k]!==undefined ? qp[k] : d);
  document.documentElement.style.setProperty('--fontFamily', val('fontFamily', getComputedStyle(document.documentElement).getPropertyValue('--fontFamily')));
  document.documentElement.style.setProperty('--fontSize', (parseInt(val('fontSize',28))||28)+'px');
  document.documentElement.style.setProperty('--textColor', val('textColor','#fff8e1'));
  document.documentElement.style.setProperty('--titleColor', val('titleColor', val('highlightColor','#ffd700')));
  document.documentElement.style.setProperty('--highlightColor', val('highlightColor','#ffd700'));
  document.documentElement.style.setProperty('--highlightRGBA', cssRGBA(val('highlightColor','#ffd700'), parseFloat(val('highlightOpacity',0.3))||0.3));
  document.documentElement.style.setProperty('--borderRadius', (parseInt(val('borderRadius',18))||18)+'px');
  const bg = cssRGBA(val('bgColor','#0b271f'), parseFloat(val('bgOpacity',0.75))||0.75);
  document.documentElement.style.setProperty('--bgRGBA', bg);
  if(val('border','none')==='none'){ document.body.classList.add('no-border'); }
  else{
    document.body.classList.remove('no-border');
    document.documentElement.style.setProperty('--borderColor', val('borderColor', val('highlightColor','#ffd700')));
  }
}

/* ===== ДВИЖОК ЧТЕНИЯ ===== */
let TEXT = '';
let words=[], spans=[], idx=-1, timer=null, running=false, paused=false;

function tokenize(t){ return (t||'').trim().split(/\s+/); }
function pauseMul(w){ if(!w) return 1; const ch=w.slice(-1); if('.!?'.includes(ch))return 3; if(',:;'.includes(ch))return 2; return 1; }

function buildDOM(){
  textEl.innerHTML = '';
  spans = [];
  const frag = document.createDocumentFragment();
  words.forEach((w, i)=>{
    const s=document.createElement('span');
    s.textContent=w;
    spans.push(s);
    frag.appendChild(s);
    if(i!==words.length-1) frag.appendChild(document.createTextNode(' '));
  });
  textEl.appendChild(frag);
}

function centerOn(el){
  const c = textEl.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  const pad = 20;
  const out = r.top < c.top + pad || r.bottom > c.bottom - pad;
  if (out) el.scrollIntoView({block:'center', inline:'nearest'}); // без smooth
}

function mark(n){
  if (n===idx) return;
  if (idx>=0 && spans[idx]) spans[idx].classList.remove('hl');
  if (n>=0 && spans[n]) { spans[n].classList.add('hl'); centerOn(spans[n]); }
  idx = n;
}

function reset(){
  words = tokenize(TEXT);
  idx=-1;
  buildDOM();
}

function step(){
  if(idx >= words.length-1){ finish(); return; }
  if(paused) return;
  mark(idx+1);
  const base=260, per=60, speed=parseFloat(rng.value);
  const d=(base + words[idx].length*per) * pauseMul(words[idx]) / speed;
  timer=setTimeout(step,d);
}

function start(){
  if(running && paused){ paused=false; play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false; step(); return; }
  if(running) return;
  reset();
  running=true; paused=false;
  play.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
  step();
}
function pause(){ if(!running) return; paused=true; play.disabled=false; pauseBtn.disabled=true; }
function stopRead(){ running=false; paused=false; clearTimeout(timer); reset(); smartScroll(); play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true; }
function finish(){ running=false; paused=false; play.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true; }

function smartScroll(){
  requestAnimationFrame(()=>{
    const overflow = textEl.scrollHeight > textEl.clientHeight + 1;
    textEl.classList.toggle('has-scroll', overflow);
    textEl.classList.toggle('no-scroll', !overflow);
  });
}
addEventListener('resize', smartScroll);

/* КНОПКИ */
const play = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const stopBtn = document.getElementById('stop');
const rng = document.getElementById('rng');
const sv  = document.getElementById('sv');
sv.textContent = parseFloat(rng.value).toFixed(1)+'×';
play.addEventListener('click', start);
pauseBtn.addEventListener('click', pause);
stopBtn.addEventListener('click', stopRead);
rng.addEventListener('input', ()=>{ sv.textContent = parseFloat(rng.value).toFixed(1)+'×'; if(running && !paused){ clearTimeout(timer); step(); } });

/* ИНИЦИАЛИЗАЦИЯ */
function renderReset(){ reset(); }
</script>
</body>
</html>
