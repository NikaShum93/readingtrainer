<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grimoire of Reading ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
  :root{ --bg:#0e1a15; --card:#11251e; --card2:#0c2019; --ink:#e9f2e9; --accent:#34d399; }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:24px 16px 8px;text-align:center}
  h1{margin:0;font-size:clamp(22px,3.4vw,38px);color:#bfffe3;text-shadow:0 0 18px #1c6e52}
  .wrap{max-width:1160px;margin:0 auto;padding:0 16px 28px;display:grid;gap:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:980px){ .grid2{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:16px 14px}
  .card h2{margin:0 0 10px;font-size:18px;color:#b2f2da}
  .row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;margin:10px 0}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label.lbl{color:#b2f2da;font-weight:800}
  input,textarea,select{width:100%;background:var(--card2);color:var(--ink);border:1.5px solid #164632;border-radius:10px;padding:10px 12px}
  textarea{min-height:110px;resize:vertical}
  .sw{display:flex;align-items:center;gap:10px}
  .swatch{width:34px;height:34px;border-radius:8px;border:2px solid #2a6b4f;cursor:pointer}
  .picker{position:absolute;opacity:0;width:0;height:0;border:0;padding:0}
  .value{min-width:46px;text-align:right;opacity:.9}
  .toggle{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #1f4b37;background:#0b1f17;border-radius:10px}
  .stack{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:linear-gradient(90deg,#20c997 0,#10b981 100%);color:#083a2b;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
  .btn.alt{background:linear-gradient(90deg,#22c55e 0,#16a34a 100%)}
  .status{margin-top:8px;padding:10px;border-radius:10px;background:#0c2018;border:1px solid #214d39;display:none}
  .ok{color:#b8ffd6}.bad{color:#ffbbbb}.warn{color:#ffe3a6}
  .code{border-radius:10px;background:#0a1e17}
  #out{width:100%;min-height:90px;border:none;background:transparent;color:var(--ink);padding:12px;font-family:ui-monospace,Consolas,monospace;white-space:pre}
  iframe{width:100%;height:440px;border:none;border-radius:12px;margin-top:8px}
</style>
</head>
<body>
<header><h1>Grimoire of Reading ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</h1></header>

<div class="wrap">

  <!-- –¢–µ–∫—Å—Ç -->
  <section class="card">
    <h2>–¢–µ–∫—Å—Ç</h2>
    <div class="row">
      <label class="lbl" for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input id="title" value="Autumn Days">
    </div>
    <div class="row">
      <label class="lbl" for="text">–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç</label>
      <textarea id="text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç‚Ä¶">The days grow colder and the nights grow longer. Leaves change their colour ‚Äî from green to gold, orange, and red. The wind blows softly through the trees, making the branches sway. Children play outside, kicking leaves high into the air. Sometimes a cloud hides the pale sun, and rain begins to fall. In the evening, families stay inside, drinking hot cocoa and telling stories by the fire. Autumn is a time of change ‚Äî a bright and cosy season before the snow.</textarea>
    </div>
  </section>

  <div class="grid2">
    <!-- –®—Ä–∏—Ñ—Ç -->
    <section class="card">
      <h2>–®—Ä–∏—Ñ—Ç –∏ —Ü–≤–µ—Ç</h2>
      <div class="row">
        <label class="lbl" for="fontPreset">–ì–∞—Ä–Ω–∏—Ç—É—Ä–∞</label>
        <select id="fontPreset">
          <optgroup label="–ß–∏—Ç–∞–±–µ–ª—å–Ω—ã–µ">
            <option value="Inter, system-ui, Arial, sans-serif">Inter</option>
            <option value="Roboto, Arial, sans-serif">Roboto</option>
            <option value="'PT Sans', Arial, sans-serif">PT Sans</option>
            <option value="'Noto Sans', Arial, sans-serif">Noto Sans</option>
          </optgroup>
          <optgroup label="–°–µ—Ä–∏—Ñ">
            <option value="Georgia, serif">Georgia</option>
            <option value="'Merriweather', Georgia, serif">Merriweather</option>
          </optgroup>
          <optgroup label="–†—É–∫–æ–ø–∏—Å–Ω—ã–µ">
            <option value="'Caveat', cursive">Caveat</option>
            <option value="'Comfortaa', cursive">Comfortaa</option>
          </optgroup>
          <optgroup label="–ú—É–ª—å—Ç—è—à–Ω—ã–µ / –∫—Ä–µ–∞—Ç–∏–≤">
            <option value="'Fredoka', 'Montserrat', sans-serif">Fredoka</option>
            <option value="'Amatic SC', cursive">Amatic SC</option>
          </optgroup>
        </select>
      </div>
      <div class="row">
        <label class="lbl" for="fontSize">–†–∞–∑–º–µ—Ä (px)</label>
        <input type="number" id="fontSize" value="28" min="16" max="72">
      </div>
      <div class="row">
        <label class="lbl">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
        <div class="sw">
          <div id="textColorBox" class="swatch"></div>
          <input id="textColor" class="picker" type="color" value="#fff8e1">
        </div>
      </div>
    </section>

    <!-- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ -->
    <section class="card">
      <h2>–ü–æ–¥—Å–≤–µ—Ç–∫–∞</h2>
      <div class="row">
        <label class="lbl">–¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
        <div class="sw">
          <div id="highlightColorBox" class="swatch"></div>
          <input id="highlightColor" class="picker" type="color" value="#ffd700">
        </div>
      </div>
      <div class="row">
        <label class="lbl" for="highlightOpacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input id="highlightOpacity" type="range" min="0" max="1" step="0.05" value="0.9" style="flex:1">
          <span id="hoVal" class="value">0.90</span>
        </div>
      </div>
      <div class="row">
        <label class="lbl" for="highlightStyle">–¢–∏–ø –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
        <select id="highlightStyle">
          <option value="background">–ü–æ–¥–ª–æ–∂–∫–∞</option>
          <option value="text">–¶–≤–µ—Ç –±—É–∫–≤</option>
        </select>
      </div>
    </section>
  </div>

  <div class="grid2">
    <!-- –§–æ–Ω –∏ —Ä–∞–º–∫–∞ -->
    <section class="card">
      <h2>–§–æ–Ω –∏ —Ä–∞–º–∫–∞</h2>
      <div class="row">
        <label class="lbl">–§–æ–Ω ‚Äî —Ü–≤–µ—Ç</label>
        <div class="sw">
          <div id="bgColorBox" class="swatch"></div>
          <input id="bgColor" class="picker" type="color" value="#0b271f">
        </div>
      </div>
      <div class="row">
        <label class="lbl" for="bgOpacity">–§–æ–Ω ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input id="bgOpacity" type="range" min="0" max="1" step="0.05" value="0.25" style="flex:1">
          <span id="boVal" class="value">0.25</span>
        </div>
      </div>
      <div class="row">
        <label class="lbl">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
        <div class="sw">
          <div id="borderColorBox" class="swatch"></div>
          <input id="borderColor" class="picker" type="color" value="#34d399">
        </div>
      </div>
      <div class="row">
        <label class="lbl" for="borderRadius">–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ (0‚Äì1000)</label>
        <input type="number" id="borderRadius" min="0" max="1000" value="18">
      </div>
      <div class="row">
        <label class="lbl">–û–ø—Ü–∏–∏</label>
        <label class="toggle"><input type="checkbox" id="noBorder"> –±–µ–∑ —Ä–∞–º–∫–∏</label>
      </div>
    </section>

    <!-- –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ -->
    <section class="card">
      <h2>–í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ</h2>
      <div class="row">
        <label class="lbl" for="fw">–®–∏—Ä–∏–Ω–∞ iframe</label>
        <input type="number" id="fw" value="900" min="300" max="3000">
      </div>
      <div class="row">
        <label class="lbl" for="fh">–í—ã—Å–æ—Ç–∞ iframe</label>
        <input type="number" id="fh" value="520" min="200" max="3000">
      </div>
      <div class="row">
        <label class="lbl">–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</label>
        <div class="stack">
          <label class="toggle"><input type="checkbox" id="allowMic" checked> microphone</label>
          <label class="toggle"><input type="checkbox" id="allowAutoplay" checked> autoplay</label>
          <label class="toggle"><input type="checkbox" id="allowFs" checked> allowfullscreen</label>
          <label class="toggle"><input type="checkbox" id="cacheBust"> –æ–±—Ö–æ–¥ –∫–µ—à–∞</label>
        </div>
      </div>

      <div class="stack" style="margin-top:8px">
        <button class="btn" id="genBtn" type="button">üîÆ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å IFRAME</button>
        <button class="btn alt" id="publishBtn" type="button">üß™ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </div>
      <div class="status" id="status"></div>
    </section>
  </div>

  <section class="card">
    <h2>–ö–æ–¥ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
    <div class="code"><textarea id="out" readonly></textarea></div>
    <iframe id="preview" allow="microphone; autoplay"></iframe>
  </section>
</div>

<script>
/* === –ö–û–ù–°–¢–ê–ù–¢–´ –ü–£–ë–õ–ò–ö–ê–¶–ò–ò (–∑–∞–º–µ–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) === */
const BASE_MAIN   = "https://nikashum93.github.io/readingtrainer/main.html";
const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
const PUBLISH_KEY = "nika_read_pub_2025";

/* === —Ö–µ–ª–ø–µ—Ä—ã === */
const $=id=>document.getElementById(id);
const showVal=(id,val)=>$(id).textContent=(+val).toFixed(2);
function bindSwatch(boxId,inputId){ const box=$(boxId),inp=$(inputId); box.style.background=inp.value; box.addEventListener('click',()=>inp.showPicker?inp.showPicker():inp.click()); inp.addEventListener('input',()=>box.style.background=inp.value); }
['textColor','highlightColor','bgColor','borderColor'].forEach(id=>bindSwatch(id+'Box',id));
$('highlightOpacity').addEventListener('input',e=>showVal('hoVal',e.target.value));
$('bgOpacity').addEventListener('input',e=>showVal('boVal',e.target.value));

/* === –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ URL === */
function buildURL(){
  let style=$('highlightStyle').value; if(style==='outline') style='text'; // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
  const border=$('noBorder').checked?'none':'solid';
  const p=new URLSearchParams({
    title:$('title').value,
    text:$('text').value, // –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç ‚Äî –ø–æ—á–∏—Å—Ç–∏–º –Ω–∏–∂–µ
    fontFamily:$('fontPreset').value,
    fontSize:String(parseInt($('fontSize').value)||28),
    textColor:$('textColor').value,
    titleColor:$('highlightColor').value,
    highlightColor:$('highlightColor').value,
    highlightOpacity:String(parseFloat($('highlightOpacity').value)||1),
    highlightStyle:style,
    bgColor:$('bgColor').value,
    bgOpacity:String(parseFloat($('bgOpacity').value)||0.25),
    border,
    borderColor:$('borderColor').value,
    borderRadius:String(parseInt($('borderRadius').value)||18)
  });

  // –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç ‚Äî –≤–æ–æ–±—â–µ —É–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä text (—á—Ç–æ–±—ã main –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ data/id/–¥–µ—Ñ–æ–ª—Ç)
  if(!p.get('text') || !p.get('text').trim()){ p.delete('text'); }

  let src=`${BASE_MAIN}?${p.toString()}`;
  if($('cacheBust').checked) src+=`&v=${Date.now()}`;
  return src;
}

/* === –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ iframe === */
function render(){
  const src=buildURL();
  $('preview').src=src;
  const allow=[ $('allowMic').checked?'microphone':'', $('allowAutoplay').checked?'autoplay':'' ].filter(Boolean).join('; ');
  const allowAttr=allow?` allow="${allow}"`:'';
  const fsAttr=$('allowFs').checked?' allowfullscreen':'';
  $('out').value=`<iframe src="${src}" width="${$('fw').value}" height="${$('fh').value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;
}
$('genBtn').addEventListener('click',render);
document.addEventListener('DOMContentLoaded',()=>{showVal('hoVal',$('highlightOpacity').value);showVal('boVal',$('bgOpacity').value);render();});

/* === –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å–æ–∑–¥–∞—ë—Ç JSON –∏ –¥–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–π URL —Å id=) === */
const statusBox=$('status');
function setStatus(html,cls=''){statusBox.style.display='block';statusBox.className='status '+cls;statusBox.innerHTML=html;}
function slug(s){return (s||'untitled').toString().toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,40)||'note'}
function stamp(){const d=new Date(),p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`}

async function publish(){
  try{
    setStatus('üîÆ –ü—É–±–ª–∏–∫—É—é‚Ä¶','warn');
    let style=$('highlightStyle').value; if(style==='outline') style='text';
    const border=$('noBorder').checked?'none':'solid';

    const data={
      title:$('title').value,
      text:$('text').value,
      fontFamily:$('fontPreset').value,
      fontSize:parseInt($('fontSize').value)||28,
      textColor:$('textColor').value,
      titleColor:$('highlightColor').value,
      highlightColor:$('highlightColor').value,
      highlightOpacity:parseFloat($('highlightOpacity').value)||1,
      highlightStyle:style,
      bgColor:$('bgColor').value,
      bgOpacity:parseFloat($('bgOpacity').value)||0.25,
      border,
      borderColor:$('borderColor').value,
      borderRadius:parseInt($('borderRadius').value)||18
    };

    const id=`${slug(data.title)}-${stamp()}`;
    const res=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json','X-Publish-Key':PUBLISH_KEY},body:JSON.stringify({id,mode:'json',folder:'data',content:JSON.stringify(data,null,2)})});
    if(!res.ok){const t=await res.text().catch(()=> '');throw new Error(res.status+' '+res.statusText+(t?': '+t:''));}

    // –æ–±–Ω–æ–≤–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ iframe –Ω–∞ —Ä–µ–∂–∏–º id=
    const src=`${BASE_MAIN}?id=${encodeURIComponent(id)}&v=${Date.now()}`;
    $('preview').src=src;
    const allow=[ $('allowMic').checked?'microphone':'', $('allowAutoplay').checked?'autoplay':'' ].filter(Boolean).join('; ');
    const allowAttr=allow?` allow="${allow}"`:'';
    const fsAttr=$('allowFs').checked?' allowfullscreen':'';
    $('out').value=`<iframe src="${src}" width="${$('fw').value}" height="${$('fh').value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;
    setStatus('‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞–¥–∞–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ.','ok');
  }catch(e){ setStatus('‚ò† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: '+e.message,'bad'); }
}
$('publishBtn').addEventListener('click',publish);
</script>
</body>
</html>
