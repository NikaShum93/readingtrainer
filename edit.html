<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ó–µ–ª—ë–Ω–∞—è –í–µ–¥—å–º–∞ ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä —á—Ç–µ–Ω–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+English:ital@0;1&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--ink:#E9F2E3;--ink-dim:#cfe2d2;--bg:#0f1b14;--panel:#0c2218e6;--accent:#6ee7b7;--accent-2:#a7f3d0;--accent-3:#34d399}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{text-align:center;padding:22px 12px 8px}
  h1{font-family:"Cinzel Decorative",serif;margin:0;color:var(--accent-2);text-shadow:0 0 16px #166f4b}
  .sub{opacity:.9;color:var(--ink-dim)}
  .panel{max-width:1060px;margin:18px auto;background:linear-gradient(180deg,#0f261c 0,#0b1f17);border:1.5px solid #1d3c2b;border-radius:16px;padding:16px}
  label{display:block;margin:10px 0 6px;font-weight:700;color:var(--accent-2)}
  input,textarea,select{width:100%;background:#0a1c15;color:var(--ink);border:1.5px solid #164632;border-radius:10px;padding:10px 12px}
  textarea{min-height:110px}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
  .toggle{display:inline-flex;gap:8px;align-items:center;background:#0b1f17;border:1px solid #1f4b37;border-radius:10px;padding:8px 10px}
  .btn{background:linear-gradient(90deg,#20c997 0,#10b981 100%);color:#083a2b;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .out{margin-top:12px;border:1px dashed #1e4b37;border-radius:12px;background:#0a1e17}
  #out{width:100%;min-height:100px;border:none;background:transparent;color:var(--ink);padding:12px;font-family:ui-monospace,Consolas,monospace;white-space:pre}
  .status{margin-top:10px;padding:10px;border-radius:10px;border:1px solid #214d39;background:#0c2018;display:none}
  .ok{color:#b8ffd6}.bad{color:#ffbbbb}.warn{color:#ffe3a6}
  iframe{width:100%;height:420px;border:none;border-radius:12px;margin-top:10px}
</style>
</head>
<body>
<header>
  <h1>Grimoire of Reading</h1>
  <div class="sub">–¢—Ä–µ–Ω–∞–∂—ë—Ä –ø–æ —á—Ç–µ–Ω–∏—é ‚Äî –∑–µ–ª—ë–Ω–∞—è –≤–µ–¥—å–º–∞</div>
</header>

<div class="panel">
  <label>Endpoint —Å–µ—Ä–≤–µ—Ä–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
  <input id="endpoint" value="https://server-kjnn.onrender.com/publish">

  <label>PUBLISH_KEY (—Å–µ–∫—Ä–µ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)</label>
  <input id="publishKey" placeholder="–≤–≤–µ–¥–∏ —Ç–æ—Ç –∂–µ –∫–ª—é—á, —á—Ç–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞">

  <div class="row">
    <div class="col">
      <label>ID (–∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ .json)</label>
      <input id="rid" value="autumn_magic_01">
    </div>
    <div class="col">
      <label>–®–∏—Ä–∏–Ω–∞ iframe</label>
      <input type="number" id="fw" value="900" min="300" max="3000">
    </div>
    <div class="col">
      <label>–í—ã—Å–æ—Ç–∞ iframe</label>
      <input type="number" id="fh" value="520" min="200" max="3000">
    </div>
  </div>

  <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
  <input id="title" value="–í–æ–ª—à–µ–±–Ω–∞—è –ø–æ–ª—ã–Ω—å">

  <label>–¢–µ–∫—Å—Ç</label>
  <textarea id="text">–í —Ç–∏—à–∏ –º—à–∏—Å—Ç–æ–≥–æ –ª–µ—Å–∞ —à—É—Ä—à–∞—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–≤–∏–¥–∏–º–æ–π –∫–Ω–∏–≥–∏. –° –∫–∞–∂–¥—ã–º –≤–¥–æ—Ö–æ–º –≤–æ–∑–¥—É—Ö –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ä–æ–º–∞—Ç–æ–º –ø–æ–ª—ã–Ω–∏, –∞ –±—É–∫–≤—ã —Ç—è–Ω—É—Ç—Å—è –∫ —Å–≤–µ—Ç—É ‚Äî –∫–∞–∫ —Å–≤–µ—Ç–ª—è—á–∫–∏ –∫ –ª—É–Ω–µ.</textarea>

  <div class="row">
    <div class="col">
      <label>CSS-—à—Ä–∏—Ñ—Ç</label>
      <input id="fontFamily" value="'IM Fell English', 'Times New Roman', serif">
    </div>
    <div class="col">
      <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
      <input type="number" id="fontSize" value="28" min="16" max="72">
    </div>
    <div class="col">
      <label>–¢–∏–ø –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
      <select id="highlightStyle">
        <option value="background">–ü–æ–¥–ª–æ–∂–∫–∞</option>
        <option value="text">–¶–≤–µ—Ç –±—É–∫–≤</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
      <input type="color" id="textColor" value="#E9F2E3">
    </div>
    <div class="col">
      <label>–¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
      <input type="color" id="highlightColor" value="#34d399">
    </div>
    <div class="col">
      <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (0‚Äì1)</label>
      <input type="range" id="highlightOpacity" min="0" max="1" step="0.05" value="1">
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–§–æ–Ω ‚Äî —Ü–≤–µ—Ç</label>
      <input type="color" id="bgColor" value="#0c1a14">
    </div>
    <div class="col">
      <label>–§–æ–Ω ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (0‚Äì1)</label>
      <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.25">
    </div>
    <div class="col">
      <label>–†–∞–º–∫–∞</label>
      <label class="toggle"><input type="checkbox" id="noBorder"> –±–µ–∑ —Ä–∞–º–∫–∏</label>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
      <input type="color" id="borderColor" value="#6ee7b7">
    </div>
    <div class="col">
      <label>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–º–∫–∏ (0‚Äì1000 px)</label>
      <input type="number" id="borderRadius" min="0" max="1000" value="18">
    </div>
    <div class="col">
      <label>–ü—Ä–∞–≤–∞ iframe</label>
      <label class="toggle"><input type="checkbox" id="allowMic" checked> microphone</label>
      <label class="toggle"><input type="checkbox" id="allowAutoplay" checked> autoplay</label>
      <label class="toggle"><input type="checkbox" id="allowFs" checked> allowfullscreen</label>
      <label class="toggle"><input type="checkbox" id="cacheBust"> –æ–±—Ö–æ–¥ –∫–µ—à–∞</label>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" id="publishBtn" type="button">üß™ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    <button class="btn" id="copyBtn" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
  </div>

  <div class="status" id="status"></div>

  <div class="out">
    <textarea id="out" readonly></textarea>
  </div>

  <iframe id="livePreview" allow="microphone; autoplay"></iframe>
</div>

<script>
const BASE_MAIN = 'https://nikashum93.github.io/readingtrainer/main.html';

// —É–¥–æ–±–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã
const $ = id => document.getElementById(id);
const statusBox = $('status');
function setStatus(html, cls=''){ statusBox.style.display='block'; statusBox.className='status '+cls; statusBox.innerHTML=html; }

// —Å–ª—É—à–∞—Ç–µ–ª–∏ ‚Äî –ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç iframe
['endpoint','publishKey','rid','title','text','fontFamily','fontSize','textColor','highlightColor','highlightOpacity','highlightStyle','bgColor','bgOpacity','borderColor','borderRadius','fw','fh','allowMic','allowAutoplay','allowFs','cacheBust','noBorder'].forEach(id=>{
  const el=$(id); if(!el) return;
  el.addEventListener(el.type==='checkbox'?'change':'input', renderIframe);
});

function buildIframeSrc(bust){
  const id = encodeURIComponent(($('rid').value || '').trim() || 'preview');
  let src = `${BASE_MAIN}?id=${id}`;
  if ($('cacheBust').checked) src += `&v=${bust || Date.now()}`;
  return src;
}

function renderIframe(){
  try{
    const src = buildIframeSrc();
    const allow = [
      $('allowMic').checked ? 'microphone' : '',
      $('allowAutoplay').checked ? 'autoplay' : ''
    ].filter(Boolean).join('; ');
    const allowAttr = allow ? ` allow="${allow}"` : '';
    const fsAttr = $('allowFs').checked ? ' allowfullscreen' : '';
    const code = `<iframe src="${src}" width="${$('fw').value}" height="${$('fh').value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;
    $('out').value = code;
    $('livePreview').src = src;
    setStatus('ü™Ñ Iframe –≥–æ—Ç–æ–≤ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∏–∂–µ).', 'ok');
  }catch(e){
    setStatus('‚ò† –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ iframe: '+e.message, 'bad');
    console.error(e);
  }
}

// –ø–µ—Ä–≤–∏—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', renderIframe);

function makeJSON(){
  const border = $('noBorder').checked ? 'none' : 'solid';
  const borderColor = $('noBorder').checked ? '' : $('borderColor').value;
  return {
    title: $('title').value,
    text: $('text').value,
    fontFamily: $('fontFamily').value,
    fontSize: parseInt($('fontSize').value)||28,
    textColor: $('textColor').value,
    titleColor: $('highlightColor').value,
    highlightColor: $('highlightColor').value,
    highlightOpacity: parseFloat($('highlightOpacity').value)||1,
    highlightStyle: $('highlightStyle').value,
    bgColor: $('bgColor').value,
    bgOpacity: parseFloat($('bgOpacity').value)||0,
    border, borderColor,
    borderRadius: parseInt($('borderRadius').value)||0
  };
}

async function publishToServer(payload){
  const endpoint = $('endpoint').value.trim();
  const key = $('publishKey').value.trim();
  if(!endpoint || !key) throw new Error('–£–∫–∞–∂–∏ endpoint –∏ PUBLISH_KEY');
  const res = await fetch(endpoint, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Publish-Key':key},
    body: JSON.stringify(payload)
  });
  if(!res.ok){ const txt=await res.text().catch(()=> ''); throw new Error(res.status+' '+res.statusText+(txt?': '+txt:'')); }
  return res.json();
}

$('publishBtn').addEventListener('click', async ()=>{
  try{
    setStatus('üîÆ –ü—É–±–ª–∏–∫—É—é‚Ä¶','warn');
    const id = ($('rid').value || '').trim();
    if(!/^[A-Za-z0-9_\-]{1,64}$/.test(id)) throw new Error('ID: –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_/-, –¥–æ 64 —Å–∏–º–≤–æ–ª–æ–≤');

    const data = makeJSON();
    const rsp = await publishToServer({
      id, mode:'json', folder:'data', content: JSON.stringify(data, null, 2)
    });

    setStatus(`‚ú® –ì–æ—Ç–æ–≤–æ. –ö–æ–º–º–∏—Ç <b>${rsp.commit||'-'}</b> ‚Ä¢ <a href="${rsp.url}" target="_blank" rel="noopener">JSON</a>`, 'ok');

    // –æ–±–Ω–æ–≤–∏–º iframe —Å –∫–µ—à-–±–∞–π–ø–∞—Å—Å–æ–º
    const src = buildIframeSrc(rsp.commit || Date.now());
    $('livePreview').src = src;
    const allow = [$('allowMic').checked?'microphone':'', $('allowAutoplay').checked?'autoplay':''].filter(Boolean).join('; ');
    const allowAttr = allow ? ` allow="${allow}"` : '';
    const fsAttr = $('allowFs').checked ? ' allowfullscreen' : '';
    $('out').value = `<iframe src="${src}" width="${$('fw').value}" height="${$('fh').value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;
  }catch(e){
    setStatus('‚ò† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: '+e.message, 'bad');
  }
});

$('copyBtn').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText($('out').value.trim()); setStatus('üìù iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'ok'); }
  catch{ const ta=$('out'); ta.focus(); ta.select(); document.execCommand('copy'); setStatus('üìù iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback)', 'ok'); }
});
</script>
</body>
</html>
