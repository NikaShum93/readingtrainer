<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grimoire of Reading ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{--ink:#e9f2e9;--ink-d:#cfe2d2;--bg:#0f1b14;--panel:#0c2218e6;--acc:#6ee7b7;--acc2:#34d399}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{text-align:center;padding:22px 12px 8px}
  h1{margin:0;font-size:clamp(22px,3.4vw,38px);font-family:"Cinzel Decorative",serif;color:#bfffe3;text-shadow:0 0 18px #1c6e52}
  .panel{max-width:1060px;margin:16px auto;background:var(--panel);border:1.5px solid #1d3c2b;border-radius:18px;padding:16px}
  label{display:block;margin:10px 0 6px;font-weight:800;color:#b2f2da}
  input,textarea,select{width:100%;background:#0a1c15;color:var(--ink);border:1.5px solid #164632;border-radius:12px;padding:10px 12px}
  textarea{min-height:110px}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
  .toggle{display:inline-flex;gap:8px;align-items:center;background:#0b1f17;border:1px solid #1f4b37;border-radius:10px;padding:8px 10px}
  .btn{background:linear-gradient(90deg,#20c997 0,#10b981 100%);color:#083a2b;border:none;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
  .status{margin-top:10px;padding:10px;border-radius:10px;border:1px solid #214d39;background:#0c2018;display:none}
  .ok{color:#b8ffd6}.bad{color:#ffbbbb}.warn{color:#ffe3a6}
  .out{margin-top:12px;border:1px dashed #1e4b37;border-radius:12px;background:#0a1e17}
  #out{width:100%;min-height:90px;border:none;background:transparent;color:var(--ink);padding:12px;font-family:ui-monospace,Consolas,monospace;white-space:pre}
  iframe{width:100%;height:420px;border:none;border-radius:12px;margin-top:10px}
</style>
</head>
<body>
<header><h1>Grimoire of Reading ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</h1></header>

<div class="panel">
  <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
  <input id="title" value="–í–æ–ª—à–µ–±–Ω–∞—è –ø–æ–ª—ã–Ω—å">

  <label>–¢–µ–∫—Å—Ç</label>
  <textarea id="text">–í —Ç–∏—à–∏ –º—à–∏—Å—Ç–æ–≥–æ –ª–µ—Å–∞ —à—É—Ä—à–∞—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–≤–∏–¥–∏–º–æ–π –∫–Ω–∏–≥–∏. –° –∫–∞–∂–¥—ã–º –≤–¥–æ—Ö–æ–º –≤–æ–∑–¥—É—Ö –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ä–æ–º–∞—Ç–æ–º –ø–æ–ª—ã–Ω–∏, –∞ –±—É–∫–≤—ã —Ç—è–Ω—É—Ç—Å—è –∫ —Å–≤–µ—Ç—É ‚Äî –∫–∞–∫ —Å–≤–µ—Ç–ª—è—á–∫–∏ –∫ –ª—É–Ω–µ.</textarea>

  <div class="row">
    <div class="col">
      <label>CSS-—à—Ä–∏—Ñ—Ç</label>
      <input id="fontFamily" value="system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">
    </div>
    <div class="col">
      <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
      <input type="number" id="fontSize" value="28" min="16" max="72">
    </div>
    <div class="col">
      <label>–¢–∏–ø –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
      <select id="highlightStyle">
        <option value="background">–ü–æ–¥–ª–æ–∂–∫–∞</option>
        <option value="text">–¶–≤–µ—Ç –±—É–∫–≤</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
      <input type="color" id="textColor" value="#E9F2E3">
    </div>
    <div class="col">
      <label>–¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏</label>
      <input type="color" id="highlightColor" value="#34d399">
    </div>
    <div class="col">
      <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (0‚Äì1)</label>
      <input type="range" id="highlightOpacity" min="0" max="1" step="0.05" value="1">
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–§–æ–Ω ‚Äî —Ü–≤–µ—Ç</label>
      <input type="color" id="bgColor" value="#0c1a14">
    </div>
    <div class="col">
      <label>–§–æ–Ω ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (0‚Äì1)</label>
      <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.25">
    </div>
    <div class="col">
      <label class="toggle"><input type="checkbox" id="noBorder"> –±–µ–∑ —Ä–∞–º–∫–∏</label>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label>–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
      <input type="color" id="borderColor" value="#6ee7b7">
    </div>
    <div class="col">
      <label>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–º–∫–∏ (0‚Äì1000 px)</label>
      <input type="number" id="borderRadius" min="0" max="1000" value="18">
    </div>
    <div class="col">
      <label>–†–∞–∑–º–µ—Ä—ã –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</label>
      <input type="number" id="fw" value="900" min="300" max="3000" style="margin-bottom:6px">
      <input type="number" id="fh" value="520" min="200" max="3000" style="margin-bottom:6px">
      <label class="toggle"><input type="checkbox" id="allowMic" checked> microphone</label>
      <label class="toggle"><input type="checkbox" id="allowAutoplay" checked> autoplay</label>
      <label class="toggle"><input type="checkbox" id="allowFs" checked> allowfullscreen</label>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="btn" id="publishBtn" type="button">üß™ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    <button class="btn" id="copyBtn" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
  </div>

  <div class="status" id="status"></div>

  <div class="out"><textarea id="out" readonly></textarea></div>
  <iframe id="preview" allow="microphone; autoplay"></iframe>
</div>

<script>
// ===== –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–≤—à–∏—Ç–æ) =====
const ENDPOINT = "https://server-kjnn.onrender.com/publish";
const PUBLISH_KEY = "nika_read_pub_2025";   // ‚ö†Ô∏è –õ—é–±–æ–π —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º —Å–º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä

const BASE_MAIN = "https://nikashum93.github.io/readingtrainer/main.html";

// utils
const $ = id => document.getElementById(id);
const statusBox = $("status");
function setStatus(html, cls=''){ statusBox.style.display='block'; statusBox.className='status '+cls; statusBox.innerHTML=html; }

function slug(s){
  return (s||'untitled')
    .toString().toLowerCase()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'') // remove accents
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,40) || 'note';
}
function stamp(){
  const d=new Date(); const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
}

// —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö
function buildData(){
  const border = $("noBorder").checked ? "none" : "solid";
  const borderColor = $("noBorder").checked ? "" : $("borderColor").value;
  return {
    title: $("title").value,
    text: $("text").value,
    fontFamily: $("fontFamily").value,
    fontSize: parseInt($("fontSize").value)||28,
    textColor: $("textColor").value,
    titleColor: $("highlightColor").value,
    highlightColor: $("highlightColor").value,
    highlightOpacity: parseFloat($("highlightOpacity").value)||1,
    highlightStyle: $("highlightStyle").value,
    bgColor: $("bgColor").value,
    bgOpacity: parseFloat($("bgOpacity").value)||0,
    border, borderColor,
    borderRadius: parseInt($("borderRadius").value)||0
  };
}

// –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —á–µ—Ä–µ–∑ Blob URL (–ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π)
function renderPreviewLocal(){
  const data = buildData();
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const url = URL.createObjectURL(blob);              // –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞
  const src = `${BASE_MAIN}?data=${encodeURIComponent(url)}`;
  $("preview").src = src;

  const allow = [
    $("allowMic").checked ? "microphone" : "",
    $("allowAutoplay").checked ? "autoplay" : ""
  ].filter(Boolean).join("; ");
  const allowAttr = allow ? ` allow="${allow}"` : "";
  const fsAttr = $("allowFs").checked ? " allowfullscreen" : "";
  $("out").value = `<iframe src="${src}" width="${$("fw").value}" height="${$("fh").value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;
  setStatus("ü™Ñ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ—Ç–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ). –ù–∞–∂–º–∏ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏.", "ok");
}

// –ª—é–±–∞—è –ø—Ä–∞–≤–∫–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é
["title","text","fontFamily","fontSize","textColor","highlightColor","highlightOpacity","highlightStyle","bgColor","bgOpacity","borderColor","borderRadius","fw","fh","allowMic","allowAutoplay","allowFs","noBorder"].forEach(id=>{
  const el=$(id); el.addEventListener(el.type==="checkbox"?"change":"input", renderPreviewLocal);
});
document.addEventListener("DOMContentLoaded", renderPreviewLocal);

// –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ —Ä–µ–ø–æ)
async function publish(){
  try{
    setStatus("üîÆ –ü—É–±–ª–∏–∫—É—é‚Ä¶","warn");
    const data = buildData();
    const id = `${slug(data.title)}-${stamp()}`;     // –∞–≤—Ç–æ-ID
    const res = await fetch(ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "X-Publish-Key": PUBLISH_KEY },
      body: JSON.stringify({ id, mode:"json", folder:"data", content: JSON.stringify(data, null, 2) })
    });
    if(!res.ok){ const t=await res.text().catch(()=> ""); throw new Error(res.status+" "+res.statusText+(t?": "+t:"")); }
    const ans = await res.json();

    // –∫–æ—Ä–æ—Ç–∫–∏–π –±–æ–µ–≤–æ–π iframe –ø–æ id
    const src = `${BASE_MAIN}?id=${encodeURIComponent(id)}`;
    $("preview").src = src;
    const allow = [
      $("allowMic").checked ? "microphone" : "",
      $("allowAutoplay").checked ? "autoplay" : ""
    ].filter(Boolean).join("; ");
    const allowAttr = allow ? ` allow="${allow}"` : "";
    const fsAttr = $("allowFs").checked ? " allowfullscreen" : "";
    $("out").value = `<iframe src="${src}" width="${$("fw").value}" height="${$("fh").value}" style="border:none;border-radius:16px;overflow:hidden;"${allowAttr}${fsAttr}></iframe>`;

    setStatus(`‚ú® –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ. –ö–æ–º–º–∏—Ç <b>${ans.commit||"-"}</b> ‚Ä¢ <a href="${ans.url}" target="_blank" rel="noopener">JSON</a><br>–ß–µ—Ä–µ–∑ 10‚Äì60 —Å–µ–∫—É–Ω–¥ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞ GitHub Pages.`, "ok");
  }catch(e){
    setStatus("‚ò† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: "+e.message, "bad");
  }
}

$("publishBtn").addEventListener("click", publish);
$("copyBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText($("out").value.trim()); setStatus("üìù iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω", "ok"); }
  catch{ const ta=$("out"); ta.focus(); ta.select(); document.execCommand("copy"); setStatus("üìù iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback)", "ok"); }
});
</script>
</body>
</html>
